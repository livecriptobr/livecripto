# Phase 2 — Polls System (Enquetes)

## Context

LivePix has a full polls (enquetes) system: streamers create polls with a title, multiple options, vote type (unique per user OR weighted by donation value), optional timer, and a real-time results widget for OBS overlay. LiveCripto currently has no poll functionality. The dashboard is at `src/app/(dashboard)/dashboard/` and the overlay system is at `src/app/(public)/overlay/`.

**Tech stack**: Next.js 15 App Router, TypeScript, Tailwind CSS 4, Prisma + PostgreSQL (Supabase), Framer Motion.

## Objective

Build a complete polls system allowing streamers to create and manage polls, let donors vote through the donation flow, and display real-time poll results on the OBS overlay.

## Tasks

### 1. Prisma Schema

Add to `prisma/schema.prisma`:

```prisma
model Poll {
  id            String       @id @default(cuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  title         String       // max 200 chars
  voteType      String       @default("unique") // "unique" | "weighted"
  status        String       @default("active") // "active" | "paused" | "closed"
  expiresAt     DateTime?    // null = no expiration
  showOnOverlay Boolean      @default(true)
  totalVotes    Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  options       PollOption[]
  votes         PollVote[]

  @@index([userId])
  @@index([userId, status])
}

model PollOption {
  id          String     @id @default(cuid())
  pollId      String
  poll        Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  text        String     // max 100 chars
  color       String     @default("#8B5CF6")
  voteCount   Int        @default(0)
  voteWeight  Int        @default(0) // sum of donation cents for weighted mode
  sortOrder   Int        @default(0)
  votes       PollVote[]

  @@index([pollId])
}

model PollVote {
  id           String     @id @default(cuid())
  pollId       String
  poll         Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  optionId     String
  option       PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  donationId   String?
  donation     Donation?  @relation(fields: [donationId], references: [id])
  voterName    String
  voterIpHash  String?    // SHA-256 hash of IP for unique vote dedup
  weight       Int        @default(1) // 1 for unique, donation cents for weighted
  createdAt    DateTime   @default(now())

  @@index([pollId])
  @@index([optionId])
  @@index([pollId, voterIpHash])
}
```

Add to `Donation` model:
```prisma
model Donation {
  // ... existing fields
  pollVoteOptionId String? // which poll option the donor voted for
}
```

Run `npx prisma migrate dev --name add_polls`.

### 2. Poll CRUD API

Create `src/app/api/polls/route.ts`:

- `GET /api/polls` — list polls for authenticated user, ordered by `createdAt` desc. Query: `?status=active`.
- `POST /api/polls` — create poll. Body:
  ```json
  {
    "title": "string (max 200)",
    "voteType": "unique" | "weighted",
    "expiresAt": "ISO date string | null",
    "options": [{ "text": "string (max 100)", "color": "#hex" }]
  }
  ```
  Validate: 2-10 options, unique option texts.

Create `src/app/api/polls/[pollId]/route.ts`:

- `GET /api/polls/[pollId]` — get poll with options and vote counts. **Public** endpoint (no auth, used by overlay widget and donation page).
- `PATCH /api/polls/[pollId]` — update poll (title, status, expiresAt). Auth required. Use for pause/resume/close.
- `DELETE /api/polls/[pollId]` — delete poll and all votes. Auth required.

### 3. Poll Voting API

Create `src/app/api/polls/[pollId]/vote/route.ts`:

- `POST` body: `{ optionId: string, voterName: string, donationId?: string }`.
- **Unique mode**: Hash requester IP with SHA-256. Check `PollVote` for existing `(pollId, voterIpHash)`. If exists, return 409 "Voce ja votou nesta enquete".
- **Weighted mode**: Require `donationId`. Fetch donation to get `amountCents` as weight. Ensure donation hasn't already been used for a vote (check `donation.pollVoteOptionId`).
- Atomically in a Prisma transaction:
  1. Create `PollVote`.
  2. Increment `PollOption.voteCount += 1` and `PollOption.voteWeight += weight`.
  3. Increment `Poll.totalVotes += 1`.
  4. If `donationId`, update `Donation.pollVoteOptionId`.
- Return updated poll with all options and current counts.

### 4. Integrate Voting into Donation Flow

Update `src/app/(public)/[username]/page.tsx`:

- Fetch active poll for the streamer: `GET /api/users/[username]/active-poll` (new endpoint that returns the first active poll).
- If active poll exists, render poll section in donation form:
  - Poll title as heading.
  - Options as styled radio buttons (each with option color accent).
  - For weighted: show "Seu voto terá peso de R$ {amount}".
  - For unique: show "1 voto por pessoa".
- On donation success, if poll option was selected, call vote API with `donationId`.

Create `src/app/api/users/[username]/active-poll/route.ts`:
- Public endpoint. Returns first active poll with options for the given username.

### 5. Poll Dashboard Page

Create `src/app/(dashboard)/dashboard/polls/page.tsx`:

- **Active polls** section: cards showing each active poll with:
  - Title, vote type badge, timer countdown (if `expiresAt`).
  - Horizontal bar chart of options with colors, vote counts, percentages.
  - Action buttons: Pause/Resume, Close, Delete, Copy widget URL.
- **Create poll** button opens form/modal:
  - Title input (max 200 chars).
  - Vote type toggle (unique / weighted) with explanation text.
  - Options list: inputs with color pickers, add/remove buttons, drag to reorder. Min 2, max 10.
  - Optional expiration: datetime picker.
  - Submit creates poll via API.
- **Closed polls** section: collapsible list of past polls with final results (read-only bars).
- Auto-refresh active polls every 5 seconds.

### 6. Poll Widget for OBS Overlay

Create `src/app/(public)/widget/poll/[pollId]/page.tsx`:

- URL format: `/widget/poll/{pollId}?token={widgetToken}`.
- Validate token (if using widget system from Phase 3) or allow public access by poll ID.
- **Transparent background** for OBS browser source.
- **Layout**:
  - Poll title at top (white text, semi-bold).
  - Each option: label, animated horizontal bar, vote count or percentage.
  - Bar colors from `PollOption.color`.
  - Winner highlight: option with most votes gets a subtle glow.
- **Auto-refresh**: `setInterval` fetch every 3 seconds from `GET /api/polls/[pollId]`.
- **Framer Motion**: `layout` prop on bars for smooth width transitions.
- **Timer**: if `expiresAt` set, show countdown (MM:SS) at bottom.
- **Closed state**: show "Enquete encerrada" banner with final results, winner highlighted.

Recommended OBS dimensions: 400x300 or 500x400.

### 7. Real-Time Updates via SSE (Enhancement)

Create `src/app/api/polls/[pollId]/stream/route.ts`:

```typescript
export async function GET(req: Request, { params }: { params: { pollId: string } }) {
  const stream = new ReadableStream({
    start(controller) {
      // Send initial poll state
      // On interval, check for updates and push
      // Or integrate with vote API to push on each vote
    },
    cancel() {
      // Cleanup
    },
  });

  return new Response(stream, {
    headers: {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive',
    },
  });
}
```

- Fallback: widget uses polling (fetch every 3s) if SSE is complex initially.
- SSE can be added later without changing the widget component (just swap fetch interval for EventSource).

### 8. Timer/Expiration Logic

- On each `GET /api/polls/[pollId]`, check if `expiresAt < now()` and `status === "active"`. If so, auto-set `status = "closed"`.
- Widget shows countdown timer if `expiresAt` is set, using `setInterval` decrementing seconds.
- Dashboard shows remaining time on active polls with expiration.
- Consider a background cleanup: on poll list fetch, close any expired polls.

## Dependencies

- No new packages required. Uses existing Prisma, Next.js API routes, Framer Motion.
- SSE: native `ReadableStream` in Next.js Route Handlers.
- Crypto: Node.js built-in `crypto.createHash('sha256')` for IP hashing.

## Acceptance Criteria

- [ ] Streamer can create a poll with 2-10 options, custom colors, and vote type selection
- [ ] Streamer can set an optional expiration timer on polls
- [ ] Donors see the active poll in the donation form and can select an option
- [ ] Unique vote type prevents duplicate votes from the same IP
- [ ] Weighted vote type counts donation amount in cents as vote weight
- [ ] Poll dashboard shows live results with colored progress bars and percentages
- [ ] OBS overlay widget displays poll with animated bars on transparent background
- [ ] Widget auto-updates results every 3 seconds (or via SSE)
- [ ] Polls auto-close when timer expires
- [ ] Streamer can pause, resume, close, and delete polls
- [ ] Closed polls show final results with winner highlighted
- [ ] Only one poll can be active per streamer at a time (or configurable)
